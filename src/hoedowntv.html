
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style media="screen">
      :root {
        --header-height: 64px;
        --main-color: #4c72b9;
        --theme-color: #395486;
        --background-color: rgb(179, 179, 179);
      }
      @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 400;
        font-display: fallback;
        src: url('../fonts/roboto-v15-latin-regular.eot'); /* IE9 Compat Modes */
        src: local('Roboto'), local('Roboto-Regular'),
           url('../fonts/roboto-v15-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
           url('../fonts/roboto-v15-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
           url('../fonts/roboto-v15-latin-regular.woff') format('woff'), /* Modern Browsers */
           url('../fonts/roboto-v15-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
           url('../fonts/roboto-v15-latin-regular.svg#Roboto') format('svg'); /* Legacy iOS */
      }
      body {
        display: flex;
        justify-content: center;
        background: var(--background-color);
        font-family: 'Roboto', 'Noto', sans-serif;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: var(--main-color);
        color: #ffffff;
        font-size: 24px;
        font-weight: bolder;
      }
      .header-shadow {
        height: 6px;
        box-shadow: inset 0px 5px 6px -3px rgba(0,0,0,0.4);
        position: absolute;
        will-change: auto;
        top: var(--header-height);
        left: 0;
        right: 0;
        pointer-events: none;
        z-index: 1;
      }
      #video {
        width: 100%;
      }
      .card {
        width: 60%;
        background: #fff;
        z-index: 1;
        position: relative;
        margin: auto;
        border-radius: 3px;
        margin-bottom: 8px;
        box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2);
        text-align: center;
        overflow: hidden;
        padding-bottom: 24px;
      }
      .container {
        position: fixed;
        will-change: auto;
        top: var(--header-height);
        margin: auto;
        bottom: 0;
        left:0;
        right:0;
        overflow: auto;
        overflow-x: hidden;
        padding:8px;
        transform: translateZ(0);
        -webkit-overflow-scrolling: touch;
        text-align: center;
        background: var(--background-color);
      }
      .playeronline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #d2d2d2;
        margin: 0 16px;
      }
      @media only screen and (max-width: 800px) {
        .card {
          width: 90%;
        }
        .playeronline {
          margin: 0 8px;
        }
      }
    </style>
    <title>Hoedown TV</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </head>
  <body>
    <header>HoedownTV</header>
    <div class="header-shadow"></div>
    <div class="container">
      <div class="card">
        <video id="video" controls poster="images/yeeeeeehawwwwwwmf.webp"></video>
        <progress id='progress-bar' min='0' max='100' value='0'></progress>
        <div id="players"></div>
      </div>
    </div>
    <script>
      function qs(selector, scope) {
        return (scope || document).querySelector(selector)
      }

      function qsa(selector, scope) {
        return (scope || document).querySelectorAll(selector)
      }

      /**
       * display statistics about a player
       *
       * @param {Object} player - player object from GameDig node js module
       */
      function displayPlayer(player) {
        var playerName = player.name;
        const wrapper = document.createElement('div');
        wrapper.classList.add('playeronline');
        const playerDiv = document.createElement('div');
        playerDiv.textContent = playerName;
        const score = document.createElement('div');
        score.textContent = player.score;
        wrapper.appendChild(playerDiv);
        wrapper.appendChild(score);
        return wrapper;
      }

      /**
       * returns a element with "server offline" text
       */
      function offlineServer() {
        const div = document.createElement('div');
        div.textContent = "Server offline";
        return div;
      }

      /**
       * returns a element with "no players online" text
       */
      function emptyServer() {
        const div = document.createElement('div');
        div.style.padding = '16px';
        div.textContent = "No Players Online";
        return div;
      }

      /**
       * lparse and display server statistics
       *
       * @param {Object} status - status object from GameDig node js module
       */
      function parseServerStatus(status) {
        const pContainer = qs('#players');
        pContainer.innerHTML = '';
        pContainer.appendChild(displayPlayer({
          name: "Player Name",
          score: "Score"
        }));
        if (status !== "offline") {
          numPlayersOnline = status.players.length;
          if (numPlayersOnline === 0) {
            pContainer.appendChild(emptyServer());
          } else {
            for (let i = 0; i < numPlayersOnline; i++) {
              pContainer.appendChild(displayPlayer(status.players[i]));
            }
          }
        } else {
          pContainer.appendChild(offlineServer());
        }
      }

      function lagCompensate(cb) {
        setTimeout(cb, 50 * 1000);
      }

      function getPlayers(firstCall) {
        fetch('https://hl2dm.dough10.me/director').then(response => {
          if (response.status !== 200) {
            console.error(response.status);
            return;
          }
          response.json().then(data => {
            if (!firstCall) {
              return lagCompensate(_ => {
                parseServerStatus(data);
              });
            }
            parseServerStatus(data);
          });
        });
      }

      function updateProgressBar() {
         var progressBar = qs('#progress-bar');
         var percentage = Math.floor((100 / video.duration) * video.currentTime);
         progressBar.value = percentage;
      }

      window.onload = _ => {
        if(Hls.isSupported()) {
          var video = qs('video');
          var hls = new Hls();
          hls.loadSource('https://hl2dm.dough10.me/hls/hl2mp.m3u8');
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, video.play);
          video.addEventListener('timeupdate', updateProgressBar, false);
        }
        getPlayers(true);
        setInterval(_ => {
          getPlayers(false);
        }, 10000);
      };
    </script>
  </body>
</html>
